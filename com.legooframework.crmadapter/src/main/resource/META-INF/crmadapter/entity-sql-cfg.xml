<?xml version="1.0" encoding="UTF-8"?>
<sqls>
    <macros>
        <macro id="crm_adapter_fields">
            <![CDATA[
             <#macro organization_fields>
                     og.id AS 'id',
                     og.code AS 'code',
                     og.parentId AS 'parentId',
                     og.orgType AS 'type',
                     og.name AS 'name',
                     og.shortName AS 'shortName',
                     og.status AS 'status',
                     og.depth AS 'depth',
                     1000000000 AS 'tenantId', 0 AS 'creator',NOW() AS 'createTime',0 AS 'editor', NOW() AS 'editTime'
	         </#macro>
	         <#macro store_fields>
                 st.id AS 'id',
                 st.detailAddress AS 'address',
                 st.status AS 'status',
                 st.organization_id AS 'organizationId',
                 st.name AS 'name',
                 st.company_id AS 'companyId',
                 st.oldStoreId AS 'oldStoreId',
                 (  SELECT sd.deviceid
                      FROM yycomm.store_device sd
                     WHERE sd.store_id = st.id
                       AND sd.company_id = st.company_id
                       AND sd.status = 1
                       AND sd.devicetype = 1 LIMIT 1 ) AS 'deviceId',
                 1000000000 AS 'tenantId', 0 AS 'creator',NOW() AS 'createTime',0 AS 'editor', NOW() AS 'editTime'
	         </#macro>
	         <#macro employee_fields>
                 em.id AS 'id',
                 em.loginuser_id AS 'loginId',
                 em.employeeState AS 'employeeState',
                 em.company_id AS 'companyId',
                 em.employeeType AS 'employeeType',
                 em.name AS 'userName',
                 em.store_id AS 'storeId',
                 em.organization_id AS 'organizationId',
                 (SELECT GROUP_CONCAT(emr.role_id)
                    FROM acp.acp_employee_role emr
                   WHERE emr.employee_id = em.id
                     AND em.status = 1) AS roleIds,
                 1000000000 AS 'tenantId', 0 AS 'creator',NOW() AS 'createTime',0 AS 'editor', NOW() AS 'editTime'
	         </#macro>
           ]]>
        </macro>
    </macros>
    <model id="CrmOrganizationEntity">
        <sql id="loadAllCompany" macros="crm_adapter_fields">
            <body><![CDATA[
             SELECT <@organization_fields />
               FROM acp.acp_organization AS og
              WHERE og.orgType = 1
            ]]></body>
        </sql>
    </model>
    <model id="CrmStoreEntity">
        <sql id="loadAllByCompany" macros="crm_adapter_fields">
            <body><![CDATA[
             SELECT <@store_fields />
               FROM acp.acp_store AS st
              WHERE st.company_id = :companyId
           ORDER BY st.id
            ]]></body>
        </sql>
        <sql id="loadAll" macros="crm_adapter_fields">
            <body><![CDATA[
             SELECT <@store_fields />
               FROM acp.acp_store AS st
           ORDER BY st.id
            ]]></body>
        </sql>
    </model>
    <model id="CrmEmployeeEntity">
        <sql id="loadAllByStore" macros="crm_adapter_fields">
            <body><![CDATA[
             SELECT <@employee_fields />
               FROM acp.acp_employee AS em
              WHERE em.store_id = :storeId
                AND em.company_id = :companyId
           ORDER BY em.id
            ]]></body>
        </sql>
    </model>
    <macros>
        <macro id="member_fields">
            <![CDATA[
		        <#macro member_fields>
	               mm.id AS 'id',
	               mm.name AS 'name',
	               mm.phone AS 'phoneNo',
				   IFNULL(mm.calendarType,1) AS 'birthdayType',
				   ( CASE IFNULL(mm.calendarType,1)
				          WHEN 1 THEN DATE_FORMAT(mm.birthday,'%m-%d')
				          WHEN 2 THEN DATE_FORMAT(mm.lunarBirthday,'%m-%d')
				          ELSE '00-00' END ) AS 'birthday',
                   mm.lastVisitTime AS 'lastVisitTime',
                   IFNULL(mm.effectiveFlag, 1) AS 'effectiveFlag',
                   mm.serviceLevel AS 'serviceLevel',
                   mm.memberType AS 'memberType',
                   mm.status AS 'status',
                   mm.company_id AS 'companyId',
                   IFNULL(mp.store_id,0) AS 'storeId',
                   ( SELECT GROUP_CONCAT(csm.shoppingguide_id)
                       FROM acp.crm_shoppingguide_member AS csm
                      WHERE csm.member_id = mm.id
                   GROUP BY csm.member_id ) AS 'shoppingGuideIds',
                   1000000000 AS 'tenantId', 0 AS 'creator',NOW() AS 'createTime',0 AS 'editor', NOW() AS 'editTime'
	            </#macro>
	         ]]>
        </macro>
    </macros>
    <model id="CrmMemberEntity">
        <sql id="loadAllByStore" macros="member_fields">
            <body><![CDATA[
            SELECT DISTINCT <@member_fields />
              FROM acp.crm_member AS mm
         LEFT JOIN acp.crm_store_member AS mp ON mp.member_id = mm.id
             WHERE mp.store_id = :storeId
               AND IFNULL(mm.effectiveFlag, 1) <> 2
               AND mm.company_id = :companyId
          ORDER BY mm.id
            ]]></body>
        </sql>
        <sql id="loadByCompany" macros="member_fields">
            <body><![CDATA[
            SELECT DISTINCT <@member_fields />
              FROM acp.crm_member AS mm
         LEFT JOIN acp.crm_store_member AS mp ON mp.member_id = mm.id
             WHERE mm.company_id = :companyId
               AND IFNULL(mp.store_id, 0) <> -1
               AND mm.id IN (${memberIds?join(",")})
          ORDER BY mm.id
            ]]></body>
        </sql>
        <sql id="loadMemberByCompany" macros="member_fields">
            <body><![CDATA[
            SELECT DISTINCT <@member_fields />
              FROM acp.crm_member AS mm
         LEFT JOIN acp.crm_store_member AS mp ON mp.member_id = mm.id
             WHERE mm.company_id = :companyId
               AND IFNULL(mp.store_id, 0) <> -1
               AND mm.id = :memberId
            ]]></body>
        </sql>
    </model>
</sqls>