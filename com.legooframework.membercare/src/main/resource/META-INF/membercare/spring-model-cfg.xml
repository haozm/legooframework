<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:batch="http://www.springframework.org/schema/batch"
       xmlns:task="http://www.springframework.org/schema/task"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd
                           http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
                           http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd">
    <bean id="memberCareBundle" class="com.legooframework.model.core.osgi.LegooBundleFactoryBean">
        <property name="resource" value="classpath:META-INF/membercare/legoo-model-cfg.xml"/>
    </bean>
    <!-- ========================= Query SQL Factory ========================= -->
    <bean id="memberCareStatementFactory" class="com.legooframework.model.core.jdbc.sqlengine.SQLStatementFactoryBean">
        <property name="patterns">
            <util:list value-type="java.lang.String">
                <value>.*[\\,/]membercare[\\,/].*-sql-cfg.xml$</value>
                <value>.*[\\,/]base[\\,/]macro-sql-cfg.xml$</value>
            </util:list>
        </property>
    </bean>
    <bean id="careCacheManager" class="com.legooframework.model.core.cache.CaffeineCacheManager">
        <property name="caffeineSpecs">
            <util:map key-type="java.lang.String" value-type="java.lang.String">
                <entry key="CrmJobsCache" value="initialCapacity=64,maximumSize=1024,expireAfterAccess=5m"/>
            </util:map>
        </property>
    </bean>
    <bean id="taskSwitchEntityAction" class="com.legooframework.model.membercare.entity.TaskSwitchEntityAction"
          parent="baseEntityAction">
        <property name="statementFactory" ref="memberCareStatementFactory"/>
        <property name="cacheManager" ref="careCacheManager"/>
        <property name="dataSource" ref="jobDataSource"/>
    </bean>
    <bean id="careRuleEntityAction" class="com.legooframework.model.membercare.entity.CareRuleEntityAction"
          parent="baseEntityAction">
        <property name="statementFactory" ref="memberCareStatementFactory"/>
        <property name="cacheManager" ref="careCacheManager"/>
        <property name="dataSource" ref="jobDataSource"/>
    </bean>
    <bean id="upcomingTaskEntityAction" class="com.legooframework.model.membercare.entity.UpcomingTaskEntityAction"
          parent="baseEntityAction">
        <property name="statementFactory" ref="memberCareStatementFactory"/>
        <property name="cacheManager" ref="careCacheManager"/>
        <property name="dataSource" ref="crmDataSource"/>
    </bean>
    <bean id="upcomingTaskDetailEntityAction"
          class="com.legooframework.model.membercare.entity.UpcomingTaskDetailEntityAction"
          parent="baseEntityAction">
        <property name="statementFactory" ref="memberCareStatementFactory"/>
        <property name="cacheManager" ref="careCacheManager"/>
        <property name="dataSource" ref="crmDataSource"/>
    </bean>
    <bean id="touch90CareLogEntityAction" class="com.legooframework.model.membercare.entity.Touch90CareLogEntityAction"
          parent="baseEntityAction">
        <property name="statementFactory" ref="memberCareStatementFactory"/>
        <property name="cacheManager" ref="careCacheManager"/>
        <property name="executorService" ref="legoo-executor"/>
        <property name="dataSource" ref="crmDataSource"/>
    </bean>
    <bean id="touch90ItemReader"
          class="com.legooframework.model.membercare.jobs.Touch90ItemReader" scope="step">
        <property name="params">
            <util:list>
                <value>#{jobParameters['companyId']}</value>
                <value>#{jobParameters['start.time']}</value>
                <value>#{jobParameters['end.time']}</value>
            </util:list>
        </property>
    </bean>
    <bean id="touch90ItemWriter" class="com.legooframework.model.membercare.jobs.Touch90ItemWriter">
        <property name="upcomingTaskAction" ref="upcomingTaskEntityAction"/>
        <property name="upcomingTaskDetailAction" ref="upcomingTaskDetailEntityAction"/>
    </bean>
    <bean id="touch90ItemProcessor" class="com.legooframework.model.membercare.jobs.Touch90ItemProcessor">
        <property name="careRuleEntityAction" ref="careRuleEntityAction"/>
        <property name="upcomingTaskAction" ref="upcomingTaskEntityAction"/>
    </bean>
    <bean id="touch90ItemListener" class="com.legooframework.model.membercare.jobs.Touch90ItemListener">
        <property name="touch90CareLogAction" ref="touch90CareLogEntityAction"/>
    </bean>

    <batch:job id="touch90Job">
        <batch:step id="step4touch90">
            <batch:tasklet transaction-manager="crmTransactionManager" start-limit="1">
                <batch:chunk reader="touch90ItemReader"
                             processor="touch90ItemProcessor"
                             writer="touch90ItemWriter"
                             commit-interval="50"/>
                <batch:transaction-attributes propagation="REQUIRED" isolation="READ_COMMITTED" timeout="60"/>
            </batch:tasklet>
            <batch:listeners>
                <batch:listener ref="touch90ItemListener"/>
            </batch:listeners>
        </batch:step>
    </batch:job>

    <bean id="memerCareJobService" class="com.legooframework.model.membercare.service.MemerCareJobService"/>
    <task:scheduled-tasks scheduler="legoo-scheduler">
        <task:scheduled ref="memerCareJobService" method="runTouchJob" cron="0 0/5 * * * ?"/>
    </task:scheduled-tasks>

    <!--<int:channel id="touch90Care-logs-channel">
        <int:queue/>
    </int:channel>
    <int:outbound-channel-adapter channel="touch90Care-logs-channel"
                                  ref="memerCareCreateService"
                                  method="handleTouch90Log">
        <int:poller fixed-delay="1000" time-unit="MILLISECONDS" receive-timeout="50000"
                    max-messages-per-poll="1"/>
    </int:outbound-channel-adapter>-->
</beans>
