<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd
                           http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd">
    <bean id="organizationBundle" class="com.legooframework.model.osgi.LegooBundleFactoryBean">
        <qualifier value="organization"/>
        <property name="resource" value="classpath:META-INF/organization/legoo-model-cfg.xml"/>
    </bean>

    <bean id="orgtStatementFactory" class="com.legooframework.model.jdbc.sqlengine.SQLStatementFactoryBean">
        <property name="patterns">
            <util:list value-type="java.lang.String">
                <value>.*[\\,/]organization[\\,/].*-sql-cfg.xml$</value>
                <value>.*[\\,/]base[\\,/]macro-sql-cfg.xml$</value>
            </util:list>
        </property>
    </bean>
    <bean id="orgCacheManager" class="com.legooframework.model.cache.CaffeineCacheManager">
        <property name="caffeineSpecs">
            <util:map key-type="java.lang.String" value-type="java.lang.String">
                <entry key="OrganizationCache" value="initialCapacity=64,maximumSize=1024,expireAfterAccess=5m"/>
            </util:map>
        </property>
    </bean>
    <!-- ========================= Query SQL Factory ========================= -->
    <bean id="orgqueryStatementFactory" class="com.legooframework.model.jdbc.sqlengine.SQLStatementFactoryBean">
        <property name="patterns">
            <util:list value-type="java.lang.String">
                <value>.*[\\,/]organization[\\,/].*-query-cfg.xml$</value>
                <value>.*[\\,/]base[\\,/]macro-sql-cfg.xml$</value>
            </util:list>
        </property>
    </bean>
    <bean id="orgJdbcQuerySupport" class="com.legooframework.model.jdbc.JdbcQuerySupport">
        <qualifier value="query"/>
        <property name="statementFactory" ref="orgqueryStatementFactory"/>
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <bean id="companyEntityAction" class="com.legooframework.model.organization.entity.CompanyEntityAction"
          parent="baseEntityAction">
        <property name="statementFactory" ref="orgtStatementFactory"/>
        <property name="cacheManager" ref="orgCacheManager"/>
    </bean>
    <bean id="storeEntityAction" class="com.legooframework.model.organization.entity.StoreEntityAction"
          parent="baseEntityAction" init-method="init">
        <property name="statementFactory" ref="orgtStatementFactory"/>
        <property name="cacheManager" ref="orgCacheManager"/>
    </bean>
    <bean id="employeeEntityAction" class="com.legooframework.model.organization.entity.EmployeeEntityAction"
          parent="baseEntityAction" init-method="init">
        <property name="statementFactory" ref="orgtStatementFactory"/>
        <property name="cacheManager" ref="orgCacheManager"/>
    </bean>
    <bean id="equipmentEntityAction" class="com.legooframework.model.organization.entity.EquipmentEntityAction"
          parent="baseEntityAction">
        <property name="statementFactory" ref="orgtStatementFactory"/>
        <property name="cacheManager" ref="orgCacheManager"/>
    </bean>
    <bean id="storeTreeAction" class="com.legooframework.model.organization.entity.StoreTreeAction"
          parent="baseEntityAction" init-method="init">
        <property name="statementFactory" ref="orgtStatementFactory"/>
        <property name="cacheManager" ref="orgCacheManager"/>
    </bean>
    <bean id="storePermissionAction" class="com.legooframework.model.organization.entity.StorePermissionAction"
          parent="baseEntityAction">
        <property name="statementFactory" ref="orgtStatementFactory"/>
        <property name="cacheManager" ref="orgCacheManager"/>
    </bean>

    <bean id="orgStoreService" class="com.legooframework.model.organization.service.StoreService"/>
    <bean id="orgCompanyService" class="com.legooframework.model.organization.service.CompanyService"/>
    <bean id="orgEmployeeService" class="com.legooframework.model.organization.service.EmployeeService"/>
    <bean id="orgEquipmentService" class="com.legooframework.model.organization.service.EquipmentService"/>

    <bean id="orgEventListenerService"
          class="com.legooframework.model.organization.service.EventListenerService"/>
    <int:chain id="org-chain" input-channel="syncEventBus" output-channel="nullChannel">
        <int:filter ref="organizationBundle"/>
        <int:service-activator ref="orgEventListenerService" method="handleMessage"/>
    </int:chain>
    <int:publish-subscribe-channel id="org-command-channel"/>
    <int:service-activator ref="orgEventListenerService" method="handleMessage"
                           input-channel="org-command-channel"/>
</beans>
