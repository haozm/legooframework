<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<macros>
		<macro id="macro_4_employee">
            <![CDATA[
            <#macro employee_select_fields alias hasnext>
               CAST(${alias}.id AS CHAR) AS 'employeeId',
               CAST(${alias}.account_id AS CHAR) AS 'accountId',
               ${alias}.user_name AS 'userName',
               ${alias}.work_no AS 'workNo',
               DATE_FORMAT(${alias}.birthday,'%Y-%m-%d') AS 'userBirthday',
               DATE_FORMAT(${alias}.employee_time,'%Y-%m-%d') AS 'employeeTime',
               (SELECT authorities FROM sec_account_info WHERE account_no = emp.work_no)
               AS 'roleNos',
               (SELECT GROUP_CONCAT(role_name) FROM 
				sec_role_info where LOCATE(id,CONCAT("'",(SELECT authorities FROM sec_account_info WHERE account_no = emp.work_no),"'")) > 0
				)AS 'roleNames',
               ${alias}.com_workstatus AS 'comWorkStatus',
               ${alias}.user_sex AS 'userSex',
               ( SELECT st.field_name
                    FROM dict_kv_data st
                   WHERE st.field_value = ${alias}.user_sex
                     AND st.dict_type = ${alias}.sex_dict ) AS 'userSexName',
               ${alias}.phone_no AS 'phoneNo',
               ${alias}.remark AS 'userRemark',
               ( SELECT st.field_name
                    FROM dict_kv_data st
                   WHERE st.field_value = ${alias}.com_workstatus
                     AND st.dict_type = ${alias}.com_workstatus_dict ) AS 'comWorkStatusName',
               ${alias}.company_id AS 'companyId',
               ${alias}.org_id AS 'orgId',
               ${alias}.store_id AS 'storeId',
            </#macro>
           ]]>
		</macro>
	</macros>
	<model id="equipment">
		<sql id="viewlist">
			<body><![CDATA[
         SELECT dbi.state AS 'deviceState',dbi.imei AS 'deviceId', odi.device_enabled AS 'deviceEnaled',
                DATE_FORMAT(odi.createTime,'%Y-%c-%d %H:%i:%s' )  AS 'createDate',
                DATE_FORMAT(odi.activate_date,'%Y-%c-%d %H:%i:%s' )  AS 'activateDate',
                '1.0.0' AS 'softVersion',
                ( SELECT obi.short_name
                    FROM org_base_info obi
                   WHERE obi.id IN (
                         SELECT osmd.store_id
                           FROM org_store_map_device osmd
                          WHERE osmd.effective_flag = 1
                            AND osmd.device_id = dbi.imei )) AS 'storeName',
                odi.device_type AS 'deviceType',
                IFNULL((SELECT od.DeviceOnline
                          FROM yycomm.OnLine_Device od
                         WHERE od.DeviceID = dbi.imei ), 0 ) AS 'onlineState'
           FROM org_device_info odi
     INNER JOIN device_base_info dbi ON odi.id = dbi.imei
          WHERE odi.company_id = :TENANT_ID
            ]]></body>
		</sql>
		<sql id="onlineview" dynamic="true">
			<body><![CDATA[
         SELECT (CASE WHEN od.WeixinOnline = 1
                      THEN 'online'
                      ELSE 'offline' END ) AS 'status',
                 COUNT(od.WeixinOnline) AS 'amount'
           FROM yycomm.OnLine_Device od
          WHERE od.WeixinOnline IN (0,1)
            AND od.DeviceID IN (<#list ids as id>'${id}'<#sep>, </#sep></#list>)
       GROUP BY WeixinOnline
            ]]></body>
		</sql>
		<sql id="status_bystore">
			<body><![CDATA[
        SELECT od.DeviceOnline AS 'deviceOnline', od.WeixinOnline AS 'weixinOnline'
          FROM yycomm.OnLine_Device od
         WHERE od.DeviceID IN ( SELECT sd.deviceid
                                  FROM yycomm.store_device sd
                                 WHERE sd.devicetype = 1
                                   AND sd.store_id = :storeId )
         LIMIT 1
            ]]></body>
		</sql>
	</model>
	<model id="company">
		<sql id="allstores">
			<body><![CDATA[
         SELECT  obi.id AS 'storeId',
	             obi.org_type AS 'orgType',
	             obi.org_code AS 'orgCode',
	             obi.full_name AS 'storeFullName',
	             obi.short_name AS 'storeShortName',
	             obi.business_license AS 'storeBusinessLicense',
	             obi.detail_address AS 'storeDetailAddress',
	             obi.legal_person AS 'storeLegalPerson',
	             obi.contact_number AS 'storeContactNumber',
	             obi.org_remark AS 'storeRemark',
                 osi.store_status AS 'storeStatus'
            FROM org_base_info AS obi
       LEFT JOIN org_store_info osi ON obi.id = osi.id
           WHERE obi.org_type =1
             AND obi.delete_flag =0
             AND obi.id IN ( SELECT osmc.store_id
                               FROM org_store_map_company AS osmc
                              WHERE osmc.company_id = :TENANT_ID
                                AND osmc.enabled =1 )
        ORDER BY obi.id
            ]]></body>
		</sql>
	</model>
	<model id="wechat">
		<sql id="statisticslist" dynamic="true">
			<body><![CDATA[
    	 		SELECT wc.*,COUNT(*) AS 'addNum',
    	 			  '' AS 'removeNum','' AS 'tranFans' 
    	 		FROM (
    	 		SELECT oi.short_name AS 'storeName',
					   wa.username AS 'userName',
					   wa.nickname AS 'nickName',
					   '' AS 'waiter',
					   COUNT(*) AS 'sumNum'
				FROM org_base_info oi 
				INNER JOIN org_store_map_wechat ow 
				ON oi.id = ow.store_id AND oi.org_type = 1 AND oi.delete_flag = 0
					   <#if storeId??>AND oi.id = ${storeId}
					   <#elseif storeIds??>AND oi.id IN (${storeIds})
					   <#elseif STORE_IDS??>AND oi.id IN (${STORE_IDS?join(", ")})</#if>
				INNER JOIN wechat_account_info wa
				ON wa.username = ow.wechat_id
				LEFT JOIN wechat_account_friend wf 
				ON ow.wechat_id = wf.account_name AND wf.delete_flag = 0)  wc 
				INNER JOIN yycomm.His_Contact hc
				ON hc.weixin = wc.username AND hc.flag = 'add' AND hc.type <> 4
				<#if (beginTime??)&&(endTime??)>
						AND hc.createtime BETWEEN :beginTime AND :endTime
				<#else>
						AND TO_DAYS(hc.createtime) = TO_DAYS(NOW())
				</#if>
    	 	]]></body>
		</sql>
		<sql id="statisticsitem" dynamic="true">
			<body><![CDATA[
    	 		SELECT wc.*,COUNT(*) AS 'addNum',
    	 		'' AS 'removeNum','' AS 'tranFans',
    	 		DATE_FORMAT(hc.createtime,'%Y-%m-%d') AS 'date' 
    	 		FROM
				(SELECT  oi.short_name AS 'storeName',
						 wa.username AS 'userName',
						 wa.nickname AS 'nickName',
						 '' AS 'waiter',
						 COUNT(*) AS 'sumNum'
				FROM org_base_info oi 
				INNER JOIN org_store_map_wechat ow 
						 ON oi.id = ow.store_id AND oi.org_type = 1 AND oi.delete_flag = 0
						 <#if storeId??>AND oi.id = ${storeId}
						 <#elseif storeIds??>AND oi.id IN (${storeIds})
						 <#elseif STORE_IDS??>AND oi.id IN (${STORE_IDS?join(", ")})</#if>
				INNER JOIN wechat_account_info wa 
						 ON wa.username = ow.wechat_id
				LEFT JOIN wechat_account_friend wf 
						 ON ow.wechat_id = wf.account_name AND wf.delete_flag = 0)  wc 
				INNER JOIN yycomm.His_Contact hc
						 ON hc.weixin = wc.username AND hc.flag = 'add' AND hc.type <> 4
				<#if (beginTime??)&&(endTime??)>
						 AND hc.createtime BETWEEN :beginTime AND :endTime
				<#else>
						 AND TO_DAYS(hc.createtime) = TO_DAYS(NOW())
				</#if>
						 GROUP BY DAY(hc.createtime)
    	 	]]></body>
		</sql>
	</model>
	<model id="employee">
		<sql id="loadByStores" macros="crud_fixed,macro_4_employee">
			<body><![CDATA[
	        SELECT <@employee_select_fields alias="emp" hasnext=true />
	               <@crud_fixed_select alias="emp" />
	          FROM org_employee_info emp
	         WHERE emp.delete_flag = 0
	           AND emp.tenant_id = :TENANT_ID
	           AND emp.org_id = :orgId
	           <#if keywords??>
	           AND (emp.work_no LIKE '%${keywords}%' OR emp.user_name LIKE '%${keywords}%' OR emp.phone_no LIKE '%${keywords}%')
	           </#if>
	           <#if workStatus??>
	           AND com_workstatus = :workStatus
	           </#if>
	           <#if beginTime??>
	           AND employee_time >= :beginTime
	           </#if>
	           <#if endTime??>
	           AND employee_time <= (:endTime + INTERVAL 1 day)
	           </#if>
	           LIMIT :offset,:rows
	            ]]></body>
		</sql>
		<sql id="loadByStores_count" dynamic="true">
			<body><![CDATA[
		        SELECT COUNT(*) 
		          	 FROM org_employee_info emp
		         WHERE emp.delete_flag = 0
		           AND emp.tenant_id = :TENANT_ID
		           AND emp.org_id = :orgId
			       <#if keywords??>
		           AND (emp.work_no LIKE '%${keywords}%' OR emp.user_name LIKE '%${keywords}%' OR emp.phone_no LIKE '%${keywords}%')
		           </#if>
		           <#if workStatus??>
		           AND com_workstatus = :workStatus
		           </#if>
		           <#if beginTime??>
		           AND employee_time >= :beginTime
		           </#if>
		           <#if endTime??>
		           AND employee_time <= (:endTime + INTERVAL 1 day)
		           </#if>
	            ]]></body>
		</sql>
	</model>
</sqls>